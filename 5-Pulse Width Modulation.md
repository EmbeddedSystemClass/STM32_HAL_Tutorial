# Pulse Width Modulation

## Intrudoction

Pulse width Modulation(PWM), is a way to reduce the average power delivered by an electrical signal. The PWM signal, is a periodic signal comprising pulses of varying duration. When the period is constant, we can change the pulse width to achieve a desired effect, which usually means average voltage and average current to control a device. So, PWM signals are often used to drive motors, servo. etc.

 ![1572166285415](Pulse%20Width%20Modulation.assets/1572166285415.png)

In STM32, PWM signals are generated by Timers(except basic timer, which has no IO pin connected). We have learned how the counter works in a STM32 timer: In up-counting mode, counter is increased by one in each clock tick, and back to zero when it meet the **ARR** value. As for generating the PWM signal, each timer (expect the basic timer) has four channels, which connect to the corresponding IO pins. Each channel in STM32 timer has a **CCRx​** register that, together with **ARR**, controls the duty cycle of PWM signal. There are two modes in PWM generation: PWM mode 1 and PWM mode 2. PWM mode 1 indicates the timer output the active signal when **CNT** < **CCRx** and output the inactive signal when **CNT** > **CCRx**, while PWM mode 2 is the opposite. And there is another property, which is polarity. When we set the polarity as high, the active signal is high, while the active signal is low when we set the polarity as low.

 ![PWM on three channels from the STM32 general purpose timer](Pulse%20Width%20Modulation.assets/pwm-output-mode.jpg) 

## Configuration on STM32CubeIDE

What’s should we do if we want to change the brightness of the LED0? We can use PWM signal to achieve it, by changing the average voltage, which is the duty cycle of the PWM signal.

![1572170921962](Pulse%20Width%20Modulation.assets/1572170921962.png)

Since LED0 is connected to **TIM1_CH1**, we should enable TIM1 and configure the channel 1 of TIM1 as **PWM Generation CH1**. Set the CH Polarity as low, because the LED is on only when the voltage is low.

![1572171070655](Pulse%20Width%20Modulation.assets/1572171070655.png)

![1572171366872](Pulse%20Width%20Modulation.assets/1572171366872.png)

Set the value of prescaler and ARR(you can set these fields to other values, just examples here) and generate the code

![1572434324678](Pulse%20Width%20Modulation.assets/1572434324678.png)

### API

```c
/**
  * @brief  Starts the PWM signal generation.
  * @param  htim TIM handle
  * @param  Channel TIM Channels to be enabled
  *          This parameter can be one of the following values:
  *            @arg TIM_CHANNEL_1: TIM Channel 1 selected
  *            @arg TIM_CHANNEL_2: TIM Channel 2 selected
  *            @arg TIM_CHANNEL_3: TIM Channel 3 selected
  *            @arg TIM_CHANNEL_4: TIM Channel 4 selected
  * @retval HAL status
  */
HAL_StatusTypeDef HAL_TIM_PWM_Start(TIM_HandleTypeDef *htim, uint32_t Channel)
```

Call this function to starts the PWM signal generation(After the initialization of TIM1)

Go to **main.c** and add the rest part in the while loop:

```c
int main(void)
{ 
  // ...
  /* USER CODE BEGIN 2 */
  HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1);
  int mode = 1;
  int pulse = 0;
  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  	HAL_Delay(10);
  	if (mode) {
  		pulse++;
  	} else {
  		pulse--;
  	}
  	if (pulse > 300) {
  		mode = 0;
  	}
  	if (pulse <= 0) {
  		mode = 1;
  	}
  	TIM1->CCR1 = pulse;
  }
  /* USER CODE END 3 */
}
```

Build the project and programm it into the MCU, the LED0 will gradually brightern and darken periodically. The maximum duty cycle is set to 33% is because the relationship of brightness and voltage is not linear and when the duty cycle is 33%, the LED is bright enough.



## Assignment

1. Use timer interrupt to change the brightness of LED0 periodically
2. Only one timer can be used.
3. Due on **November 6, 2019 11:00pm**